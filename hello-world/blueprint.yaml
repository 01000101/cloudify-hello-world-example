#######
# Cloudify Hello World blueprint.
#
# The blueprint describes an OpenStack vm created using Cloudify's OpenStack plugin
# and simple web server started using Cloudify's script plugin.
# In addition, an OpenStack floating ip and security group are created and associated with the created vm.
#

imports:
    - http://www.getcloudify.org/spec/cloudify/3.1/types.yaml
    - http://www.getcloudify.org/spec/openstack-plugin/1.1/plugin.yaml
    - http://www.getcloudify.org/spec/script-plugin/1.1/plugin.yaml

inputs:
    webserver_port:
        description: >
            The HTTP web server port
        default: 8080

node_templates:
    virtual_ip:
        type: cloudify.openstack.floatingip

    security_group:
        type: cloudify.openstack.security_group
        properties:
            security_group:
                name: webserver_security_group
            rules:
                -   remote_ip_prefix: 0.0.0.0/0
                    port: { get_input: webserver_port }

    vm:
        type: cloudify.openstack.server
        ####################################################################################
        # Uncomment bellow and fill the properties according to your openstack environment.#
        ####################################################################################
        #properties:
        #    cloudify_agent:
        #        user: [Enter-User-Name]
        #    server:
        #        name: bash-web-server
        #        image_name: [Enter-Image-Name]
        #        flavor_name: [Enter-Flavor-Name]
        #        key_name: cloudify-agents-kp
        #        security_groups: ['webserver_security_group']
        relationships:
            -   type: cloudify.openstack.server_connected_to_floating_ip
                target: virtual_ip
            -   type: cloudify.relationships.connected_to
                target: security_group


    http_web_server:
        type: cloudify.types.web_server
        properties:
            port: { get_input: webserver_port }
        relationships:
            -   type: cloudify.relationships.contained_in
                target: vm
        interfaces:
            cloudify.interfaces.lifecycle:
                -   configure:
                        mapping: script.script_runner.tasks.run
                        properties:
                            script_path: scripts/configure.sh
                -   start:
                        mapping: script.script_runner.tasks.run
                        properties:
                            script_path: scripts/start.sh
                -   stop:
                        mapping: script.script_runner.tasks.run
                        properties:
                            script_path: scripts/stop.sh
